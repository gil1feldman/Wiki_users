<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>עריכות אחרונות של עורכי ויקיפדיה</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { font-family: Arial, sans-serif; direction: rtl; padding: 20px; margin: 0; background: #f9f9f9; }
    .form-row > div { display: flex; align-items: center; gap: 6px; }
    .share-button, button {
      background-color: #007BFF; color: white; border: none; padding: 10px 16px;
      cursor: pointer; border-radius: 6px; transition: background-color 0.3s;
    }
    .share-button:hover, button:hover { background-color: #0056b3; }
    .table-wrapper { overflow-x: auto; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { padding: 12px 8px; border-bottom: 1px solid #ddd; text-align: center; }
    th { background-color: #007BFF; color: white; }
    .action-link { background-color: #28a745; color: white; padding: 6px 10px; border-radius: 4px; text-decoration: none; }
    .no-action { background-color: #6c757d; color: white; padding: 6px 10px; border-radius: 4px; }
    .form-area { margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .form-row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    input, select {
      width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px;
      font-size: 16px; box-sizing: border-box;
    }
    @media (max-width: 768px) {
      .form-row { flex-direction: column; }
      .form-row > div { width: 100%; }
    }
  </style>
</head>
<body>
<h1>עריכות אחרונות של עורכי ויקיפדיה</h1>

<div class="form-area">
  <div class="form-row">
    <div><i class="fas fa-user"></i><input type="text" id="editorInput" placeholder="שם משתמש" /></div>
    <div>
      <i class="fas fa-file-alt"></i>
      <input type="text" id="titleInput" placeholder="שם ערך" list="titleSuggestions" disabled />
      <datalist id="titleSuggestions"></datalist>
    </div>
    <div><i class="fas fa-calendar"></i>
      <select id="dateRange">
        <option value="7">7 ימים אחרונים</option>
        <option value="30">30 ימים אחרונים</option>
        <option value="90">90 ימים אחרונים</option>
        <option value="180">180 ימים אחרונים</option>
      </select>
    </div>
    <div><i class="fas fa-filter"></i>
      <select id="editType">
        <option value="">הכל</option>
        <option value="add">הוספה</option>
        <option value="remove">מחיקה</option>
        <option value="new">יצירת ערך חדש</option>
      </select>
    </div>
    <div style="display: flex; gap: 10px;">
      <button class="share-button" onclick="copyShareLink()"><i class="fas fa-share-alt"></i> שתף קישור</button>
      <button class="share-button" onclick="exportCSV()"><i class="fas fa-file-csv"></i> ייצא ל־CSV</button>
    </div>
    <div><button onclick="searchEdits()"><i class="fas fa-search"></i> חפש</button></div>
  </div>
</div>

<div class="table-wrapper">
  <table id="resultsTable">
    <thead>
      <tr>
        <th>שם הערך</th>
        <th>תאריך עריכה</th>
        <th>הערות</th>
        <th>גודל השינוי</th>
        <th>גרסה קודמת</th>
        <th>קישור לערך</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<datalist id="titleSuggestions"></datalist>

<script>
let loadedEdits = [];

window.onload = () => {
  const urlParams = new URLSearchParams(window.location.search);
  const userParam = urlParams.get('user');
  const daysParam = urlParams.get('days');
  if (userParam) document.getElementById('editorInput').value = userParam;
  if (daysParam) document.getElementById('dateRange').value = daysParam;
  if (userParam || daysParam) searchEdits();
};

document.getElementById('editType').addEventListener('change', applyFilters);

function copyShareLink() {
  const editor = document.getElementById('editorInput').value.trim();
  const days = document.getElementById('dateRange').value;
  if (!editor) return alert('יש לבחור או להזין שם משתמש');
  const base = window.location.origin + window.location.pathname;
  const link = `${base}?user=${encodeURIComponent(editor)}&days=${encodeURIComponent(days)}`;
  navigator.clipboard.writeText(link).then(() => alert('הקישור הועתק ללוח!'));
}

function searchEdits() {
  const username = document.getElementById('editorInput').value.trim();
  const dateRange = parseInt(document.getElementById('dateRange').value);
  if (!username) return alert('יש לבחור או להזין שם משתמש');

  const sinceDate = new Date(Date.now() - dateRange * 86400000);
  const url = `https://he.wikipedia.org/w/api.php?action=query&list=usercontribs&ucuser=${encodeURIComponent(username)}&uclimit=500&ucprop=title|timestamp|comment|sizediff|ids&format=json&origin=*`;

  fetch(url)
    .then(response => response.json())
    .then(data => {
      loadedEdits = (data?.query?.usercontribs || []).filter(edit => new Date(edit.timestamp) >= sinceDate);
      document.getElementById('titleInput').disabled = false;
      applyFilters();
    })
    .catch(err => {
      console.error(err);
      alert('שגיאה בטעינת הנתונים');
    });
}

function applyFilters() {
  const titleFilter = document.getElementById('titleInput').value.trim().toLowerCase();
  const editType = document.getElementById('editType').value;

  const filtered = loadedEdits.filter(edit => {
    const matchesTitle = !titleFilter || edit.title.toLowerCase().includes(titleFilter);
    let matchesType = true;
    if (editType === 'add') matchesType = edit.sizediff > 0 && edit.parentid !== 0;
    else if (editType === 'remove') matchesType = edit.sizediff < 0;
    else if (editType === 'new') matchesType = edit.parentid === 0;
    return matchesTitle && matchesType;
  });

  renderTable(filtered);
  renderSuggestions(filtered);
}

function renderTable(filtered) {
  const resultsBody = document.querySelector("#resultsTable tbody");
  resultsBody.innerHTML = '';

  if (!filtered.length) {
    resultsBody.innerHTML = `<tr><td colspan="6">לא נמצאו עריכות</td></tr>`;
    return;
  }

  filtered.forEach(edit => {
    const row = document.createElement('tr');
    const diffLink = (edit.parentid && edit.parentid !== 0)
      ? `<a href="https://he.wikipedia.org/w/index.php?diff=${edit.revid}&oldid=${edit.parentid}" target="_blank" class="action-link">צפה</a>`
      : `<span class="no-action">עריכה חדשה</span>`;
    const pageUrl = `https://he.wikipedia.org/wiki/${encodeURIComponent(edit.title.replace(/ /g, '_'))}`;
    row.innerHTML = `
      <td>${edit.title}</td>
      <td>${new Date(edit.timestamp).toLocaleString('he-IL')}</td>
      <td>${edit.comment || ''}</td>
      <td>${edit.sizediff > 0 ? '+' : ''}${edit.sizediff}</td>
      <td>${diffLink}</td>
      <td><a href="${pageUrl}" target="_blank" class="action-link">לערך</a></td>`;
    resultsBody.appendChild(row);
  });
}

function renderSuggestions(filtered) {
  const titles = [...new Set(filtered.map(edit => edit.title))];
  const dataList = document.getElementById('titleSuggestions');
  dataList.innerHTML = '';
  titles.forEach(title => {
    const option = document.createElement('option');
    option.value = title;
    dataList.appendChild(option);
  });
}

function exportCSV() {
  const rows = Array.from(document.querySelectorAll("#resultsTable tr"));
  if (rows.length < 2) return alert("אין נתונים לייצוא");

  const csv = rows.map(row => {
    const cells = Array.from(row.querySelectorAll("th, td"));
    return cells.map(cell => `"${cell.innerText.replace(/"/g, '""')}"`).join(",");
  }).join("\n");

  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "wiki_edits.csv";
  link.click();
}
</script>
</body>
</html>
