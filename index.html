/* כל הקוד שלך נשמר */
/* נוסיף עכשיו את הפונקציה החסרה searchEdits לתחתית הקובץ */

<script>
// ... שאר הקוד נשמר כפי שהוא

function searchEdits() {
    const selectValue = document.getElementById('editorSelect').value;
    const inputValue = document.getElementById('editorInput').value.trim();
    const username = inputValue || selectValue;
    const dateRange = parseInt(document.getElementById('dateRange').value);

    const resultsTable = document.getElementById('resultsTable');
    const resultsBody = resultsTable.querySelector('tbody');
    resultsBody.innerHTML = '';

    const summaryTable = document.getElementById('summaryTable');
    const summaryBody = summaryTable.querySelector('tbody');
    summaryBody.innerHTML = '';

    if (!username) return alert('יש לבחור או להזין שם משתמש');

    const now = new Date();
    const sinceDate = new Date(now.getTime() - dateRange * 24 * 60 * 60 * 1000);

    const url = `https://he.wikipedia.org/w/api.php?action=query&list=usercontribs&ucuser=${encodeURIComponent(username)}&uclimit=500&ucprop=title|timestamp|comment|sizediff|ids&format=json&origin=*`;

    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error(`סטטוס שגוי: ${response.status}`);
            return response.json();
        })
        .then(data => {
            const contribs = data?.query?.usercontribs || [];
            const filtered = contribs.filter(edit => new Date(edit.timestamp) >= sinceDate);

            if (!filtered.length) {
                resultsBody.innerHTML = `<tr><td colspan="6">לא נמצאו עריכות ב-${dateRange} הימים האחרונים</td></tr>`;
                resultsTable.style.display = 'table';
                summaryTable.style.display = 'none';
                return;
            }

            filtered.forEach(edit => {
                const row = document.createElement('tr');
                const diffUrl = `https://he.wikipedia.org/w/index.php?diff=${edit.revid}&oldid=${edit.parentid}`;
                const pageUrl = `https://he.wikipedia.org/wiki/${encodeURIComponent(edit.title.replace(/ /g, '_'))}`;

                row.innerHTML = `
                    <td>${edit.title}</td>
                    <td>${new Date(edit.timestamp).toLocaleString('he-IL')}</td>
                    <td>${edit.comment || ''}</td>
                    <td>${edit.sizediff > 0 ? '+' : ''}${edit.sizediff}</td>
                    <td><a href="${diffUrl}" target="_blank">צפה</a></td>
                    <td><a href="${pageUrl}" target="_blank">לערך</a></td>
                `;
                resultsBody.appendChild(row);
            });
            resultsTable.style.display = 'table';

            const summaryMap = {};
            filtered.forEach(edit => {
                if (!summaryMap[edit.title]) {
                    summaryMap[edit.title] = { count: 0, lastEdit: new Date(edit.timestamp) };
                }
                summaryMap[edit.title].count++;
                const editTime = new Date(edit.timestamp);
                if (editTime > summaryMap[edit.title].lastEdit) {
                    summaryMap[edit.title].lastEdit = editTime;
                }
            });

            const summaryRows = Object.entries(summaryMap)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);

            summaryRows.forEach(([title, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${title}</td>
                    <td>${data.count}</td>
                    <td>${data.lastEdit.toLocaleString('he-IL')}</td>
                `;
                summaryBody.appendChild(row);
            });
            summaryTable.style.display = 'table';
        })
        .catch(error => {
            console.error('שגיאה בטעינת הנתונים:', error);
            alert('אירעה שגיאה בטעינת הנתונים. ודא שאתה פותח את הדף משרת מקומי או אתר מאובטח.');
        });
}
</script>
</body>
</html>
